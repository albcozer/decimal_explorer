<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Decimal Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&display=swap');

        body {
            font-family: 'Fredoka', sans-serif;
            touch-action: none; /* Prevent browser zooming/scrolling */
            background-color: #f0f9ff;
            overflow: hidden;
        }

        .noselect {
            user-select: none;
            -webkit-user-select: none;
        }

        /* Custom scrollbar for the controls if needed */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 1);
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.15);
        }

        .needle-shadow {
            filter: drop-shadow(0px 4px 4px rgba(0,0,0,0.3));
        }

        .btn-bounce:active {
            transform: scale(0.95);
        }

        /* Fraction Display Styles */
        .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            margin: 0 0.2em;
        }
        .fraction .top {
            display: block;
            border-bottom: 2px solid currentColor;
            padding: 0 0.2em;
            line-height: 1.2;
        }
        .fraction .bottom {
            display: block;
            padding: 0 0.2em;
            line-height: 1.2;
        }

        /* Mixed Number Styles */
        .mixed-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-family: 'Fredoka', sans-serif;
        }
        .mixed-whole {
            font-size: 2em;
            font-weight: 600;
            color: #334155;
            line-height: 1;
        }
        .mixed-fraction {
            display: inline-block;
            text-align: center;
            font-size: 1.1em;
            color: #475569;
        }
        .mixed-fraction .top {
            display: block;
            border-bottom: 2px solid currentColor;
            padding: 0 4px;
        }
        .mixed-fraction .bottom {
            display: block;
            padding: 0 4px;
        }

        /* Modal Transitions */
        .modal-enter { opacity: 0; transform: scale(0.9); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s, transform 0.2s; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.9); transition: opacity 0.2s, transform 0.2s; }
        
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* AI Gradient Text */
        .text-gradient-ai {
            background: linear-gradient(to right, #4f46e5, #9333ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-between text-slate-700 relative">

    <!-- School Logo -->
    <img src="https://static.wixstatic.com/media/2c7593_8b882f5bd0ea4a68b258a22f401463cc~mv2.png/v1/crop/x_0,y_9,w_606,h_398/fill/w_696,h_454,al_c,lg_1,q_85,enc_avif,quality_auto/Epstein%20Logo_SMALL.png" alt="School Logo" class="absolute bottom-4 left-4 w-24 z-0 opacity-80 pointer-events-none noselect">

    <!-- Header & Value Display -->
    <div class="w-full max-w-2xl px-4 pt-4 z-10 flex-none">
        <div class="glass-panel rounded-3xl p-6 text-center w-full relative overflow-hidden">
            <!-- Decorative blobs -->
            <div class="absolute -top-10 -left-10 w-20 h-20 bg-blue-200 rounded-full blur-2xl opacity-50"></div>
            <div class="absolute -bottom-10 -right-10 w-24 h-24 bg-purple-200 rounded-full blur-2xl opacity-50"></div>
            
            <h1 class="text-xl text-slate-400 font-semibold mb-2 tracking-wide uppercase text-sm">Current Value</h1>
            
            <!-- Main Number Display -->
            <div id="valueDisplay" class="text-7xl font-semibold text-blue-600 tracking-tight transition-colors duration-200">
                0.0
            </div>

            <!-- Place Value Breakdown -->
            <div id="breakdown" class="flex justify-center gap-2 mt-4 font-mono text-sm h-8">
                <!-- Javascript will populate this -->
            </div>
        </div>
    </div>

    <!-- The Canvas Ruler -->
    <div class="relative w-full flex-grow flex items-center justify-center overflow-hidden cursor-grab active:cursor-grabbing" id="canvasContainer">
        
        <!-- Background Grid (Visual Decoration) -->
        <div class="absolute inset-0 z-0 opacity-10" style="background-image: radial-gradient(#3b82f6 1px, transparent 1px); background-size: 20px 20px;"></div>

        <!-- The Canvas -->
        <canvas id="rulerCanvas" class="z-10 w-full h-full"></canvas>

        <!-- The Static Needle (Center) -->
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none z-20 flex flex-col items-center">
            <!-- Arrow Head -->
            <div class="text-red-500 text-5xl mt-2 needle-shadow">
                <i class="fas fa-caret-up"></i>
            </div>
            <!-- Line extending down -->
            <div class="w-1 h-32 bg-red-500 rounded-full -mt-2 opacity-50"></div>
        </div>

        <!-- Zoom Level Indicator (Floating) -->
        <div id="zoomBadge" class="absolute top-4 right-4 bg-white/90 px-3 py-1 rounded-full text-xs font-bold text-blue-500 shadow-sm border border-blue-100 z-20 transition-all opacity-0">
            Zoom: Whole Numbers
        </div>
    </div>

    <!-- Controls -->
    <div class="w-full max-w-md px-6 pb-8 z-10 flex-none relative">
        <div class="glass-panel rounded-2xl p-4 flex flex-col gap-4">
            
            <!-- Zoom Controls -->
            <div class="flex items-center justify-between gap-4 w-full">
                <button id="btnZoomOut" class="btn-bounce w-12 h-12 bg-blue-100 hover:bg-blue-200 text-blue-600 rounded-full flex items-center justify-center text-xl transition-colors shadow-sm" aria-label="Zoom Out">
                    <i class="fas fa-minus"></i>
                </button>

                <div class="text-center flex-grow">
                    <span id="zoomLabel" class="text-xs font-bold text-slate-400 uppercase block mb-1">Zoom Level</span>
                    <div class="flex justify-center gap-1">
                        <div id="dot1" class="w-2 h-2 rounded-full bg-blue-500 transition-all"></div>
                        <div id="dot2" class="w-2 h-2 rounded-full bg-slate-300 transition-all"></div>
                        <div id="dot3" class="w-2 h-2 rounded-full bg-slate-300 transition-all"></div>
                        <div id="dot4" class="w-2 h-2 rounded-full bg-slate-300 transition-all"></div>
                        <div id="dot5" class="w-2 h-2 rounded-full bg-slate-300 transition-all"></div>
                    </div>
                </div>

                <button id="btnZoomIn" class="btn-bounce w-12 h-12 bg-blue-100 hover:bg-blue-200 text-blue-600 rounded-full flex items-center justify-center text-xl transition-colors shadow-sm" aria-label="Zoom In">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <!-- Standard Actions -->
            <div class="flex gap-3">
                 <button id="btnReset" class="btn-bounce flex-1 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold rounded-xl text-sm transition-colors shadow-sm flex items-center justify-center gap-2">
                    <i class="fas fa-undo"></i> Reset
                </button>
                 <button id="btnFractions" class="btn-bounce flex-1 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-xl text-sm transition-colors shadow-sm flex items-center justify-center gap-2">
                    <i class="fas fa-divide"></i> Fractions
                </button>
                 <button id="btnMixed" class="btn-bounce flex-1 py-2 bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-xl text-sm transition-colors shadow-sm flex items-center justify-center gap-2">
                    <i class="fas fa-layer-group"></i> Mixed #
                </button>
            </div>
            
            <!-- AI Actions -->
            <div class="flex gap-3">
                 <button id="btnMagicExplain" class="btn-bounce flex-1 py-2 bg-gradient-to-r from-indigo-100 to-purple-100 hover:from-indigo-200 hover:to-purple-200 text-indigo-700 font-semibold rounded-xl text-sm transition-colors shadow-sm flex items-center justify-center gap-2 border border-indigo-200">
                    <i class="fas fa-magic"></i> Magic Explain
                </button>
            </div>
        </div>
        
        <div class="text-center mt-3 text-slate-400 text-xs">
            Drag ruler to move • Scroll to zoom
            <div class="mt-2 opacity-75">Copyright(c) 2025, Alberto Cozer (acozer@gmail.com)</div>
        </div>
    </div>

    <!-- Fractions Modal Overlay -->
    <div id="fractionModal" class="fixed inset-0 z-[200] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden transition-all duration-200">
        <div class="bg-white rounded-3xl shadow-2xl w-[90%] max-w-md p-6 relative transform transition-all duration-200 scale-95 opacity-0" id="modalContent">
            
            <button id="btnCloseModal" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center transition-colors">
                <i class="fas fa-times"></i>
            </button>

            <h2 class="text-xl font-bold text-slate-700 mb-1 text-center">Fraction Equivalents</h2>
            <p class="text-slate-400 text-sm text-center mb-6">Ways to write <span id="modalCurrentValue" class="font-bold text-blue-500">0.5</span></p>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-blue-50 rounded-2xl p-4 flex flex-col items-center justify-center border-2 border-blue-100">
                    <span class="text-xs font-bold text-blue-400 uppercase mb-2">Decimal Fraction</span>
                    <div id="fracBase" class="text-3xl text-blue-600 font-bold"></div>
                </div>
                <div class="bg-green-50 rounded-2xl p-4 flex flex-col items-center justify-center border-2 border-green-100">
                    <span class="text-xs font-bold text-green-400 uppercase mb-2">Simplified</span>
                    <div id="fracSimple" class="text-3xl text-green-600 font-bold"></div>
                </div>
                <div class="bg-slate-50 rounded-2xl p-4 flex flex-col items-center justify-center border-2 border-slate-100">
                    <span class="text-xs font-bold text-slate-400 uppercase mb-2">Equivalent</span>
                    <div id="fracEq1" class="text-3xl text-slate-600 font-bold"></div>
                </div>
                <div class="bg-slate-50 rounded-2xl p-4 flex flex-col items-center justify-center border-2 border-slate-100">
                    <span class="text-xs font-bold text-slate-400 uppercase mb-2">Equivalent</span>
                    <div id="fracEq2" class="text-3xl text-slate-600 font-bold"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- Mixed Number Modal Overlay -->
    <div id="mixedModal" class="fixed inset-0 z-[200] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden transition-all duration-200">
        <div class="bg-white rounded-3xl shadow-2xl w-[90%] max-w-md p-6 relative transform transition-all duration-200 scale-95 opacity-0 text-center" id="mixedModalContent">
            
            <button id="btnCloseMixedModal" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center transition-colors">
                <i class="fas fa-times"></i>
            </button>

            <h2 class="text-xl font-bold text-slate-700 mb-1">Mixed Numbers</h2>
            <p class="text-slate-400 text-sm mb-6">Combining Wholes & Parts for <span id="mixedCurrentValue" class="font-bold text-amber-500">1.5</span></p>

            <div class="space-y-4">
                <!-- Visual Breakdown -->
                <div class="bg-amber-50 rounded-2xl p-6 border-2 border-amber-100">
                    <span class="text-xs font-bold text-amber-500 uppercase mb-4 block">Representation</span>
                    <div id="mixedDisplay" class="flex items-center justify-center gap-8">
                        <!-- JS Insert -->
                    </div>
                </div>

                <!-- Detailed Explanation -->
                <div class="grid grid-cols-2 gap-4">
                     <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                        <div class="text-xs text-slate-400 uppercase font-bold mb-1">Whole Part</div>
                        <div id="mixedWholeDisplay" class="text-2xl font-bold text-slate-700">1</div>
                     </div>
                     <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                        <div class="text-xs text-slate-400 uppercase font-bold mb-1">Fraction Part</div>
                        <div id="mixedFracDisplay" class="text-2xl font-bold text-slate-700">1/2</div>
                     </div>
                </div>
            </div>

        </div>
    </div>

    <!-- AI Modal Overlay -->
    <div id="aiModal" class="fixed inset-0 z-[200] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden transition-all duration-200">
        <!-- Increased width to max-w-2xl for side-by-side layout -->
        <div class="bg-white rounded-3xl shadow-2xl w-[95%] max-w-2xl p-6 relative transform transition-all duration-200 scale-95 opacity-0 text-center" id="aiModalContent">
            
            <button id="btnCloseAiModal" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center transition-colors z-10">
                <i class="fas fa-times"></i>
            </button>

            <!-- Loading State -->
            <div id="aiLoader" class="hidden flex-col items-center justify-center py-12">
                <div class="loader mb-4"></div>
                <p class="text-slate-500 font-medium animate-pulse">Consulting the Math Wizard...</p>
            </div>

            <!-- Content State -->
            <div id="aiContent" class="hidden text-left">
                <div class="flex flex-col md:flex-row items-center gap-6">
                    <!-- Image Container -->
                    <div class="w-32 md:w-48 flex-shrink-0 flex items-center justify-center">
                         <img id="aiMascot" src="" alt="Math Mascot" class="w-full h-auto object-contain max-h-48">
                    </div>
                    
                    <!-- Text Container -->
                    <div class="flex-grow">
                        <h2 id="aiTitle" class="text-2xl font-bold mb-3 text-gradient-ai">✨ Magic Explain</h2>
                        <div id="aiBody" class="text-slate-600 text-lg leading-relaxed">
                            <!-- Content goes here -->
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Gemini API Configuration ---
        const apiKey = "AIzaSyDJnk2OiYC-7rI_pdSWDH3LNTXgK-F1faE"; // Runtime environment provides key

        // --- Configuration ---
        const canvas = document.getElementById('rulerCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('canvasContainer');
        const valueDisplay = document.getElementById('valueDisplay');
        const breakdownDisplay = document.getElementById('breakdown');
        const zoomBadge = document.getElementById('zoomBadge');

        // State
        let state = {
            centerValue: 0.5, 
            pixelsPerUnit: 200, 
            isDragging: false,
            lastMouseX: 0,
            velocity: 0,
            lastFrameTime: 0,
            riddleAnswer: null // Stores current riddle target
        };

        // Constants
        const MIN_ZOOM = 50;   
        const MAX_ZOOM = 40000; 
        const FRICTION = 0.92;
        
        // Colors
        const COLORS = {
            textMain: '#334155',
            textSub: '#94a3b8',
            tickWhole: '#3b82f6',     
            tickLandmark: '#3b82f6',  
            tickGeneric: '#cbd5e1',   
            textLandmark: '#3b82f6'   
        };

        // --- Initialization ---

        function resize() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            draw();
        }

        window.addEventListener('resize', resize);
        resize();

        // --- Core Logic ---

        function getPrecisionLevel() {
            if (state.pixelsPerUnit < 120) return { type: 'whole', label: 'Whole Numbers (0 decimals)', fractionDigits: 0, level: 1 };
            if (state.pixelsPerUnit < 800) return { type: 'tenths', label: 'Tenths (1 decimal)', fractionDigits: 1, level: 2 };
            if (state.pixelsPerUnit < 3000) return { type: 'hundredths', label: 'Hundredths (2 decimals)', fractionDigits: 2, level: 3 };
            if (state.pixelsPerUnit < 12000) return { type: 'thousandths', label: 'Thousandths (3 decimals)', fractionDigits: 3, level: 4 };
            return { type: 'ten-thousandths', label: 'Ten-Thousandths (4 decimals)', fractionDigits: 4, level: 5 };
        }

        function updateUI() {
            const precision = getPrecisionLevel();
            const roundedVal = state.centerValue.toFixed(precision.fractionDigits);
            
            valueDisplay.innerText = roundedVal;

            const dots = [1, 2, 3, 4, 5]; 
            const activeLevel = precision.level;

            const zoomLabel = document.getElementById('zoomLabel');
            let labelText = "Zoom Level";
            if (activeLevel === 1) labelText += " (Whole Number)";
            else if (activeLevel === 2) labelText += " (One Decimal Digit)";
            else if (activeLevel === 3) labelText += " (Two Decimal Digits)";
            else if (activeLevel === 4) labelText += " (Three Decimal Digits)";
            else if (activeLevel === 5) labelText += " (Four Decimal Digits)";
            
            zoomLabel.innerText = labelText;

            dots.forEach(i => {
                const el = document.getElementById(`dot${i}`);
                if (i <= activeLevel) {
                    el.classList.remove('bg-slate-300');
                    el.classList.add('bg-blue-500');
                } else {
                    el.classList.remove('bg-blue-500');
                    el.classList.add('bg-slate-300');
                }
            });

            let html = '';
            const split = roundedVal.split('.');
            html += `<span class="text-slate-500">Whole: <b class="text-slate-700">${split[0]}</b></span>`;
            
            if (split[1]) {
                let placeLabel = "";
                const len = split[1].length;
                if (len === 1) placeLabel = "Tenths";
                else if (len === 2) placeLabel = "Hundredths";
                else if (len === 3) placeLabel = "Thousandths";
                else if (len >= 4) placeLabel = "Ten-Thousandths";

                html += `<span class="mx-1 text-slate-300">|</span>`;
                html += `<span class="text-blue-500">Decimal: <b class="text-blue-700">.${split[1]}</b> <span class="text-sm font-normal text-blue-400">(${placeLabel})</span></span>`;
            }
            breakdownDisplay.innerHTML = html;

            zoomBadge.innerText = `Seeing ${precision.label}`;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const w = canvas.width;
            const h = canvas.height;
            const cy = h / 2 + 50; 
            
            const ppu = state.pixelsPerUnit;
            let step = 1;

            if (ppu >= 120) step = 0.1;     
            if (ppu >= 800) step = 0.01;    
            if (ppu >= 3000) step = 0.001;  
            if (ppu >= 12000) step = 0.0001; 
            
            const unitsInView = w / ppu;
            const startValue = state.centerValue - (unitsInView / 2);
            const endValue = state.centerValue + (unitsInView / 2);

            let currentTick = Math.floor((startValue - step) / step) * step;
            let safeGuard = 0;

            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';

            while (currentTick < endValue + step && safeGuard < 3000) {
                safeGuard++;
                currentTick = parseFloat(currentTick.toFixed(5));
                
                const isWhole = Math.abs(currentTick % 1) < 0.00001;
                
                let checkStr = currentTick.toFixed(5);
                checkStr = checkStr.replace(/\.?0+$/, "");
                const endsInFive = checkStr.endsWith('5');
                const decimalPlaces = checkStr.includes('.') ? checkStr.split('.')[1].length : 0;

                let height = 15; 
                let color = COLORS.tickGeneric; 
                let lineWidth = 1;
                let showLabel = false;
                let fontSize = 12;
                let fontColor = COLORS.textSub;
                let yOffset = 0;

                if (isWhole) {
                    height = 100;
                    color = COLORS.tickWhole;
                    lineWidth = 3;
                    showLabel = true;
                    fontSize = 24;
                    fontColor = COLORS.textMain;
                    yOffset = -15;
                } 
                else if (endsInFive) {
                    height = 60;
                    color = COLORS.tickLandmark; 
                    lineWidth = 2;
                    fontColor = COLORS.textLandmark;
                    
                    showLabel = true;
                    if (decimalPlaces === 1 && ppu < 40) showLabel = false;
                    else if (decimalPlaces === 2 && ppu < 300) showLabel = false;
                    else if (decimalPlaces === 3 && ppu < 1500) showLabel = false;
                    else if (decimalPlaces === 4 && ppu < 6000) showLabel = false;
                    
                    fontSize = decimalPlaces > 2 ? 12 : 14;
                } 
                else {
                    height = 35;
                    if (decimalPlaces >= 3) height = 25;
                    if (decimalPlaces >= 4) height = 20;

                    color = COLORS.tickGeneric; 
                    
                    if (decimalPlaces === 1 && ppu > 250) showLabel = true; 
                    else if (decimalPlaces === 2 && ppu > 2000) showLabel = true;
                    else if (decimalPlaces === 3 && ppu > 6000) showLabel = true;
                    else if (decimalPlaces === 4 && ppu > 20000) showLabel = true;

                    fontSize = decimalPlaces >= 2 ? 10 : 11;
                    fontColor = COLORS.textSub;
                }

                const x = (currentTick - state.centerValue) * state.pixelsPerUnit + (w / 2);

                ctx.beginPath();
                ctx.moveTo(x, cy);
                ctx.lineTo(x, cy - height);
                ctx.strokeStyle = color;
                ctx.lineWidth = lineWidth;
                ctx.stroke();

                if (showLabel) {
                    ctx.font = `600 ${fontSize}px Fredoka`;
                    ctx.fillStyle = fontColor;
                    let labelTxt = isWhole ? currentTick.toFixed(0) : checkStr;
                    ctx.fillText(labelTxt, x, cy - height - 10 + yOffset);
                }

                currentTick += step;
            }

            ctx.beginPath();
            ctx.moveTo(0, cy);
            ctx.lineTo(w, cy);
            ctx.strokeStyle = '#cbd5e1';
            ctx.lineWidth = 1;
            ctx.stroke();
            
            updateUI();
        }

        // --- Interaction Logic ---
        function handleStart(x) {
            state.isDragging = true;
            state.lastMouseX = x;
            state.velocity = 0;
            container.classList.add('cursor-grabbing');
            container.classList.remove('cursor-grab');
        }

        function handleMove(x) {
            if (!state.isDragging) return;
            const dx = x - state.lastMouseX;
            state.lastMouseX = x;
            const valueChange = dx / state.pixelsPerUnit;
            state.centerValue -= valueChange;
            state.velocity = -valueChange; 
            requestAnimationFrame(draw);
        }

        function handleEnd() {
            state.isDragging = false;
            container.classList.remove('cursor-grabbing');
            container.classList.add('cursor-grab');
            requestAnimationFrame(inertiaLoop);
        }

        container.addEventListener('mousedown', e => handleStart(e.clientX));
        window.addEventListener('mousemove', e => handleMove(e.clientX));
        window.addEventListener('mouseup', handleEnd);

        container.addEventListener('touchstart', e => handleStart(e.touches[0].clientX));
        window.addEventListener('touchmove', e => {
            e.preventDefault(); 
            handleMove(e.touches[0].clientX);
        }, { passive: false });
        window.addEventListener('touchend', handleEnd);

        container.addEventListener('wheel', e => {
            e.preventDefault();
            const zoomSpeed = 0.0015;
            const delta = -e.deltaY;
            let newZoom = state.pixelsPerUnit * (1 + delta * zoomSpeed);
            newZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, newZoom));
            state.pixelsPerUnit = newZoom;
            zoomBadge.style.opacity = '1';
            clearTimeout(window.zoomBadgeTimeout);
            window.zoomBadgeTimeout = setTimeout(() => {
                zoomBadge.style.opacity = '0';
            }, 1500);
            draw();
        }, { passive: false });

        function inertiaLoop() {
            if (state.isDragging) return;
            if (Math.abs(state.velocity) < 0.00001) return;
            state.centerValue += state.velocity;
            state.velocity *= FRICTION; 
            draw();
            requestAnimationFrame(inertiaLoop);
        }

        document.getElementById('btnReset').addEventListener('click', () => {
            const startVal = state.centerValue;
            const duration = 500;
            const startTime = performance.now();
            state.velocity = 0;
            function step(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 4);
                state.centerValue = startVal - (startVal * ease);
                draw();
                if (progress < 1) requestAnimationFrame(step);
                else { state.centerValue = 0; draw(); }
            }
            requestAnimationFrame(step);
        });

        document.getElementById('btnZoomIn').addEventListener('click', () => {
            animateZoom(state.pixelsPerUnit * 2);
        });

        document.getElementById('btnZoomOut').addEventListener('click', () => {
            animateZoom(state.pixelsPerUnit / 2);
        });

        function animateZoom(targetZoom) {
            targetZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, targetZoom));
            const startZoom = state.pixelsPerUnit;
            const duration = 300;
            const startTime = performance.now();
            function step(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 3);
                state.pixelsPerUnit = startZoom + (targetZoom - startZoom) * ease;
                draw();
                if (progress < 1) requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

        // --- Fraction Modal Logic ---
        const modal = document.getElementById('fractionModal');
        const modalContent = document.getElementById('modalContent');
        const btnFractions = document.getElementById('btnFractions');
        const btnCloseModal = document.getElementById('btnCloseModal');
        const modalCurrentValue = document.getElementById('modalCurrentValue');

        // Mixed Modal Elements
        const mixedModal = document.getElementById('mixedModal');
        const mixedModalContent = document.getElementById('mixedModalContent');
        const btnMixed = document.getElementById('btnMixed');
        const btnCloseMixedModal = document.getElementById('btnCloseMixedModal');
        const mixedCurrentValue = document.getElementById('mixedCurrentValue');

        function getGCD(a, b) {
            return b ? getGCD(b, a % b) : a;
        }

        function createFractionHTML(n, d) {
            return `<div class="fraction"><span class="top">${n}</span><span class="bottom">${d}</span></div>`;
        }

        function createMixedHTML(w, n, d) {
            let html = '<div class="mixed-wrapper">';
            
            // Show Whole number
            html += `<span class="mixed-whole">${w}</span>`;
            
            // Show Fraction if exists
            if (n > 0) {
                 html += `<div class="mixed-fraction"><span class="top">${n}</span><span class="bottom">${d}</span></div>`;
            }
            html += '</div>';
            return html;
        }

        function calculateAndShowFractions() {
            const precision = getPrecisionLevel();
            const valStr = state.centerValue.toFixed(precision.fractionDigits);
            const val = parseFloat(valStr);

            modalCurrentValue.innerText = valStr;

            let num, den;
            const parts = valStr.split('.');
            if (parts.length === 1) {
                num = parseInt(parts[0]);
                den = 1;
            } else {
                const decimalLen = parts[1].length;
                den = Math.pow(10, decimalLen);
                num = Math.round(val * den);
            }

            document.getElementById('fracBase').innerHTML = createFractionHTML(num, den);

            const gcd = getGCD(Math.abs(num), den);
            const simpleNum = num / gcd;
            const simpleDen = den / gcd;
            document.getElementById('fracSimple').innerHTML = createFractionHTML(simpleNum, simpleDen);

            let equivalents = [];
            [2, 3, 4, 5, 10, 100].forEach(m => {
                let n = simpleNum * m;
                let d = simpleDen * m;
                if (d !== den && d !== simpleDen) {
                     equivalents.push({n, d});
                }
            });

            if (val === 0) equivalents = [{n: 0, d: 2}, {n: 0, d: 100}];

            const eq1 = equivalents[0] || {n: simpleNum*2, d: simpleDen*2};
            const eq2 = equivalents[1] || {n: simpleNum*10, d: simpleDen*10};

            document.getElementById('fracEq1').innerHTML = createFractionHTML(eq1.n, eq1.d);
            document.getElementById('fracEq2').innerHTML = createFractionHTML(eq2.n, eq2.d);

            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.style.opacity = '1';
                modalContent.style.transform = 'scale(1)';
            }, 10);
        }

        function calculateAndShowMixed() {
            const precision = getPrecisionLevel();
            const valStr = state.centerValue.toFixed(precision.fractionDigits);
            const val = parseFloat(valStr);

            mixedCurrentValue.innerText = valStr;

            const whole = Math.floor(val);
            const decimalPart = val - whole;

            // Calculate Fraction Part
            let num = 0, den = 1;
            
            if (decimalPart > 0.000001) {
                const parts = valStr.split('.');
                if (parts.length > 1) {
                    const decimalStr = parts[1];
                    den = Math.pow(10, decimalStr.length);
                    num = parseInt(decimalStr);
                    
                    // Simplify
                    const gcd = getGCD(num, den);
                    num /= gcd;
                    den /= gcd;
                }
            }

            // Populate Main Display
            document.getElementById('mixedDisplay').innerHTML = createMixedHTML(whole, num, den);
            
            // Populate Breakdown
            document.getElementById('mixedWholeDisplay').innerText = whole;
            document.getElementById('mixedFracDisplay').innerHTML = (num > 0) ? `${num}/${den}` : "0";

            // Open Modal
            mixedModal.classList.remove('hidden');
            setTimeout(() => {
                mixedModalContent.style.opacity = '1';
                mixedModalContent.style.transform = 'scale(1)';
            }, 10);
        }

        function closeModal() {
            modalContent.style.opacity = '0';
            modalContent.style.transform = 'scale(0.95)';
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        function closeMixedModal() {
            mixedModalContent.style.opacity = '0';
            mixedModalContent.style.transform = 'scale(0.95)';
            setTimeout(() => {
                mixedModal.classList.add('hidden');
            }, 200);
        }

        btnFractions.addEventListener('click', calculateAndShowFractions);
        btnCloseModal.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        btnMixed.addEventListener('click', calculateAndShowMixed);
        btnCloseMixedModal.addEventListener('click', closeMixedModal);
        mixedModal.addEventListener('click', (e) => { if (e.target === mixedModal) closeMixedModal(); });

        // --- AI API Logic ---
        
        const aiModal = document.getElementById('aiModal');
        const aiModalContent = document.getElementById('aiModalContent');
        const btnCloseAiModal = document.getElementById('btnCloseAiModal');
        const aiLoader = document.getElementById('aiLoader');
        const aiContent = document.getElementById('aiContent');
        const aiTitle = document.getElementById('aiTitle');
        const aiBody = document.getElementById('aiBody');
        const btnMagicExplain = document.getElementById('btnMagicExplain');

        // Mascot Images (using ?raw=true to ensure they load as images)
        const mascotImages = [
            "https://raw.githubusercontent.com/albcozer/decimal_explorer/refs/heads/main/image_1-BackgroundRemoved.png",
            "https://raw.githubusercontent.com/albcozer/decimal_explorer/refs/heads/main/Image_2-BackgroundRemoved.png",
            "https://raw.githubusercontent.com/albcozer/decimal_explorer/refs/heads/main/Image_3-BackgroundRemoved.png"
        ];

        function openAiModal() {
            // Pick random mascot
            const randomImg = mascotImages[Math.floor(Math.random() * mascotImages.length)];
            document.getElementById('aiMascot').src = randomImg;

            aiModal.classList.remove('hidden');
            setTimeout(() => {
                aiModalContent.style.opacity = '1';
                aiModalContent.style.transform = 'scale(1)';
            }, 10);
        }

        function closeAiModal() {
            aiModalContent.style.opacity = '0';
            aiModalContent.style.transform = 'scale(0.95)';
            setTimeout(() => {
                aiModal.classList.add('hidden');
            }, 200);
        }

        async function callGemini(prompt) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "Oops! The math wizard is taking a nap. Try again later.";
            }
        }

        // Feature 1: Magic Explain
        btnMagicExplain.addEventListener('click', async () => {
            openAiModal();
            aiLoader.classList.remove('hidden');
            aiLoader.classList.add('flex');
            aiContent.classList.add('hidden');
            
            const precision = getPrecisionLevel();
            const val = state.centerValue.toFixed(precision.fractionDigits);
            
            const prompt = `Explain the decimal number ${val} to a 5th grader using a creative, fun analogy involving everyday objects (like food, money, or sports). Keep it very short (under 30 words). Be cheerful and encouraging.`;

            const text = await callGemini(prompt);

            aiLoader.classList.add('hidden');
            aiLoader.classList.remove('flex');
            aiContent.classList.remove('hidden');
            
            aiTitle.innerText = `✨ Magic Explain: ${val}`;
            aiBody.innerText = text;
        });

        btnCloseAiModal.addEventListener('click', closeAiModal);
        aiModal.addEventListener('click', (e) => { if (e.target === aiModal) closeAiModal(); });


        draw();

    </script>
</body>
</html>
